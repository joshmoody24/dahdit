# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Architecture Overview

This is a **multi-layer architecture** with a Rust core compiled to WebAssembly:

1. **Core Rust Implementation** (`core/`)
   - `src/lib.rs` - Main module and re-exports
   - `src/types.rs` - Core data structures and enums with serde JSON support
   - `src/patterns.rs` - Morse pattern lookup table with O(1) character access
   - `src/timing.rs` - Text → Timing element conversion with humanization
   - `src/audio.rs` - Audio synthesis (radio and telegraph modes)
   - `src/interpret.rs` - Signal interpretation (Morse → Text)
   - **Pure Rust library** - No WASM dependencies by default

2. **WASM Bindings Layer** (`bindings/wasm/`)
   - `src/lib.rs` - WebAssembly bindings and JavaScript API
   - Depends on `morse-core` crate
   - Handles JSON deserialization and WASM-specific types
   - Re-exports enums with `#[wasm_bindgen]` for JavaScript compatibility

3. **WASM Core Package** (`bindings/javascript/wasm-core/`)
   - Generated by `wasm-pack` from `bindings/wasm/` - never modify manually
   - Contains `morse_wasm.js`, `morse_wasm_bg.wasm`, and type definitions
   - Pure WebAssembly bindings with minimal JavaScript wrapper

4. **User-Facing Package** (`bindings/javascript/wrapper/`)
   - `morse.js` - Clean JavaScript API with Web Audio integration
   - `test.js` - Comprehensive test suite
   - `package.json` - Depends on the wasm-core package
   - Uses top-level await for immediate WASM initialization

## Core Functions & Data Flow

**Two-phase processing model:**
1. `timing::morse_timing()` - Text → Timing elements (dots/dashes/gaps with durations)
2. `audio::morse_audio()` - Timing elements → Audio samples with envelope processing

**Key Rust types** (in `src/types.rs`):
- `MorseTimingParams` - Input parameters (WPM, humanization, etc.)
- `MorseAudioParams` - Audio parameters with radio/telegraph mode settings
- `MorseElement` - Individual timing element (type + duration)
- `MorseAudioMode` - Radio (tones) vs Telegraph (clicks) synthesis

## Build Commands

**Rust development:**
```bash
cd core/
cargo test        # Run Rust tests
cargo fmt         # Format code
cargo clippy      # Lint code
```

**Universal commands (from project root):**
```bash
make test         # Run all tests (Rust core + JS wrapper)
make build        # Build everything (core + WASM + wrapper)
make dev          # Run format, lint, test, then build
make clean        # Clean all build artifacts
make format       # Format all code (Rust + JS)
make lint         # Lint Rust code with clippy
```

**Component-specific commands:**
```bash
cd core/
cargo test        # Run Rust tests
cargo fmt         # Format Rust code
cargo clippy      # Lint Rust code

cd bindings/wasm/
cargo build       # Build WASM bindings

cd bindings/javascript/wrapper/
npm test          # Run JavaScript tests
npm run build     # Build WASM from Rust
npm run format    # Format JavaScript code
```

**Development environment:**
```bash
nix develop       # Enter dev shell with Rust, wasm-pack, Node.js
```

## Adding New Parameters

**Completely automatic with JSON serialization** - no manual bindings needed:

1. **Add fields to Rust structs** in `core/src/types.rs` (e.g., `MorseTimingParams`, `MorseAudioParams`)
2. **Add to Default implementation** for the struct
3. **Rebuild** with `make build`

That's it! New parameters are automatically available in JavaScript thanks to:
- `#[serde(rename_all = "camelCase", default)]` attributes on structs
- JSON deserialization in WASM bindings
- JavaScript API passes entire config objects as JSON strings

Example: Add `fade_in_ms: f32` to `MorseAudioParams` → immediately available as `fadeInMs` in JavaScript.

## Prosign Syntax

Text processing supports **bracket prosigns**: `[SOS]` generates `...---...` with 1-dot spacing between characters (not 3-dot). Spaces inside brackets are ignored. Regular text uses standard ITU spacing rules.

## Performance Characteristics

- **Character lookup**: O(1) via direct array indexing `morse_patterns[ch]`
- Supports both uppercase and lowercase via duplicate table entries
- **Timing generation**: CPU-bound, scales linearly
- **Audio generation**: Memory/math-bound due to floating-point calculations

## Deployment

**GitHub Pages**: Automatic deployment via `.github/workflows/pages.yml` builds WASM and deploys to `https://joshmoody24.github.io/dahdit`

**npm publishing**: From `bindings/javascript/wrapper/` directory, `npm publish` after `npm run build`